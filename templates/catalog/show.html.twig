{% extends 'base.html.twig' %}

{% block title %}{{ product.title }} - Recyclum{% endblock %}

{% block meta_description %}
    {{ product.shortDescription ?: product.title ~ ' reconditionné. Garantie ' ~ product.warrantyMonths ~ ' mois.' }}
{% endblock %}

{% block structured_data %}
    <script type="application/ld+json">
        {
            "@context": "https://schema.org/",
            "@type": "Product",
            "name": {{ product.title|json_encode|raw }},
    "description": {{ (product.shortDescription ?: product.title)|json_encode|raw }},
        {% if product.mainImageFilename %}
    "image": "{{ absolute_url(asset('uploads/products/' ~ product.mainImageFilename)) }}",
    {% endif %}
    {% if product.brand %}
    "brand": {
        "@type": "Brand",
        "name": {{ product.brand.name|json_encode|raw }}
    },
    {% endif %}
        "offers": {
            "@type": "Offer",
            "url": "{{ absolute_url(path('catalog_show', {slug: product.slug})) }}",
        "priceCurrency": "EUR",
        "price": "{{ (product.price / 100)|number_format(2, '.', '') }}",
        "availability": "{{ product.stock > 0 ? 'https://schema.org/InStock' : 'https://schema.org/OutOfStock' }}",
        "itemCondition": "https://schema.org/RefurbishedCondition"
    }
}
    </script>
{% endblock %}

{% block body %}
    <div class="product-detail">
        {# Breadcrumb #}
        <nav class="breadcrumb" aria-label="Fil d'Ariane">
            <div class="container">
                <ol class="breadcrumb-list">
                    <li><a href="{{ path('app_home') }}">Accueil</a></li>
                    <li><a href="{{ path('catalog_index') }}">Produits</a></li>
                    {% if product.category %}
                        <li>
                            <a href="{{ path('catalog_index', {category: product.category.slug}) }}">
                                {{ product.category.name }}
                            </a>
                        </li>
                    {% endif %}
                    <li aria-current="page">{{ product.title }}</li>
                </ol>
            </div>
        </nav>

        <div class="container">
            <div class="product-layout">
                {# Galerie avec Stimulus #}
                <div class="product-gallery" data-controller="gallery">
                    {% set sortedImages = product.images|sort((a, b) => a.position <=> b.position) %}

                    {% if sortedImages|length > 0 %}
                        {# Image principale avec zoom #}
                        <div class="gallery-main" data-controller="image-zoom">
                            {% set mainImage = product.mainImage ?: sortedImages|first %}
                            <a
                                href="{{ asset('uploads/products/' ~ mainImage.filename) }}"
                                class="glightbox main-image-link"
                                data-gallery="product-gallery"
                                data-image-zoom-target="container"
                            >
                                <img
                                    src="{{ asset('uploads/products/' ~ mainImage.filename) }}"
                                    alt="{{ mainImage.alt ?: product.title }}"
                                    class="main-image"
                                    data-image-zoom-target="image"
                                >
                                <div class="zoom-hint">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="11" cy="11" r="8"></circle>
                                        <path d="m21 21-4.35-4.35"></path>
                                    </svg>
                                    <span>Cliquer pour agrandir</span>
                                </div>
                            </a>
                        </div>

                        {# Miniatures #}
                        {% if sortedImages|length > 1 %}
                            <div class="gallery-thumbnails">
                                {% for image in sortedImages %}
                                    <a
                                        href="{{ asset('uploads/products/' ~ image.filename) }}"
                                        class="glightbox thumbnail{{ image.isMain ? ' is-main' : '' }}"
                                        data-gallery="product-gallery"
                                    >
                                        <img
                                            src="{{ asset('uploads/products/' ~ image.filename) }}"
                                            alt="{{ image.alt ?: product.title }}"
                                            loading="lazy"
                                        >
                                    </a>
                                {% endfor %}
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="gallery-placeholder">
                            <svg width="120" height="120" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                <polyline points="21 15 16 10 5 21"></polyline>
                            </svg>
                            <p>Aucune image disponible</p>
                        </div>
                    {% endif %}
                </div>

                {# Informations produit #}
                <div class="product-info">
                    {# Titre + badges #}
                    <div class="info-header">
                        <h1 class="product-title">{{ product.title }}</h1>

                        <div class="product-badges">
                            {% if product.energyLabel %}
                                <span class="badge energy-badge energy-{{ product.energyLabel.value|lower }}">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path>
                                </svg>
                                Classe {{ product.energyLabel.value }}
                            </span>
                            {% endif %}

                            {% if product.stock > 0 %}
                                <span class="badge badge-success">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                                En stock
                            </span>
                            {% else %}
                                <span class="badge badge-danger">Rupture</span>
                            {% endif %}
                        </div>
                    </div>

                    {# Marque #}
                    {% if product.brand %}
                        <p class="product-brand">
                            Par <strong>{{ product.brand.name }}</strong>
                        </p>
                    {% endif %}

                    {# Prix + CTA avec Stimulus #}
                    <div class="price-block">
                        <div class="price-wrapper">
                            <span class="price-label">Prix</span>
                            <span class="product-price">
            {{ (product.price / 100)|number_format(2, ',', ' ') }} €
        </span>
                        </div>

                        <div class="cta-group" data-controller="cta-actions">
                            {# CTA Principal - Achat #}
                            <a href="#contact" class="btn btn-primary btn-lg" data-action="click->cta-actions#scrollToSection" data-cta-actions-section-param="contact">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                                Je l'achète !
                            </a>

                            {# Séparateur visuel #}
                            <div class="cta-separator">
                                <span class="separator-line"></span>
                                <span class="separator-text">ou</span>
                                <span class="separator-line"></span>
                            </div>

                            {# CTA Secondaire - Réparation #}
                            <div class="repair-callout">
                                <p class="repair-question">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                                    </svg>
                                    Vous avez déjà un appareil similaire en panne ?
                                </p>
                                <a href="#repair" class="btn btn-outline btn-lg" data-action="click->cta-actions#scrollToSection" data-cta-actions-section-param="repair">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
                                    </svg>
                                    Faire réparer mon appareil
                                </a>
                            </div>
                        </div>
                    </div>

                    {# Description #}
                    {% if product.shortDescription %}
                        <div class="info-section">
                            <h2 class="section-title">Description</h2>
                            <p class="product-description">{{ product.shortDescription }}</p>
                        </div>
                    {% endif %}

                    {# Caractéristiques #}
                    <div class="info-section">
                        <h2 class="section-title">Caractéristiques</h2>
                        <dl class="specs-list">
                            {% if product.category %}
                                <div class="spec-item">
                                    <dt>Catégorie</dt>
                                    <dd>
                                        <a href="{{ path('catalog_index', {category: product.category.slug}) }}">
                                            {{ product.category.name }}
                                        </a>
                                    </dd>
                                </div>
                            {% endif %}

                            {% if product.warrantyMonths %}
                                <div class="spec-item">
                                    <dt>Garantie</dt>
                                    <dd>{{ product.warrantyMonths }} mois</dd>
                                </div>
                            {% endif %}

                            <div class="spec-item">
                                <dt>État</dt>
                                <dd>Reconditionné professionnel</dd>
                            </div>

                            <div class="spec-item">
                                <dt>Stock</dt>
                                <dd>{{ product.stock > 0 ? product.stock ~ ' unité(s) disponible(s)' : 'Rupture de stock' }}</dd>
                            </div>
                        </dl>
                    </div>

                    {# Trust signals #}
                    <div class="trust-signals">
                        <div class="trust-item">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                            </svg>
                            <div class="trust-content">
                                <strong>Garantie {{ product.warrantyMonths ?: 12 }} mois</strong>
                                <span>Protection complète</span>
                            </div>
                        </div>

                        <div class="trust-item">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                            <div class="trust-content">
                                <strong>Testé et certifié</strong>
                                <span>Contrôle qualité rigoureux</span>
                            </div>
                        </div>

                        <div class="trust-item">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                <circle cx="12" cy="10" r="3"></circle>
                            </svg>
                            <div class="trust-content">
                                <strong>Livraison France</strong>
                                <span>Expédition rapide et sécurisée</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {# Produits similaires #}
            {% if relatedProducts|length > 0 %}
                <section class="related-section" data-controller="scroll-reveal">
                    <h2 class="section-title-large">Produits similaires</h2>
                    <div class="products-grid products-grid-small">
                        {% for relatedProduct in relatedProducts %}
                            <article class="product-card" data-scroll-reveal-target="element">
                                <a href="{{ path('catalog_show', {slug: relatedProduct.slug}) }}" class="card-link">
                                    <div class="card-image">
                                        {% if relatedProduct.mainImageFilename %}
                                            <img
                                                src="{{ asset('uploads/products/' ~ relatedProduct.mainImageFilename) }}"
                                                alt="{{ relatedProduct.title }}"
                                                loading="lazy"
                                            >
                                        {% else %}
                                            <div class="card-placeholder">
                                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                                    <polyline points="21 15 16 10 5 21"></polyline>
                                                </svg>
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="card-content">
                                        <h3 class="card-title">{{ relatedProduct.title }}</h3>
                                        <span class="card-price">
                                        {{ (relatedProduct.price / 100)|number_format(2, ',', ' ') }} €
                                    </span>
                                    </div>
                                </a>
                            </article>
                        {% endfor %}
                    </div>
                </section>
            {% endif %}
        </div>
    </div>
{% endblock %}
