{% extends 'base.html.twig' %}

{% block title %}Catalogue — Électroménager reconditionné{% endblock %}
{% block meta_description %}Découvrez notre large sélection d'électroménagers reconditionnés : réfrigérateurs, lave-linge, fours... Garantis jusqu'à 24 mois.{% endblock %}

{% block body %}

    {# === HERO CATALOGUE MODERNE === #}
    <section class="catalog-hero-modern">
        <div class="catalog-hero-gradient"></div>
        <div class="container">
            <div class="catalog-hero-inner">
                <div>
                    <h1 class="catalog-hero-title">Catalogue</h1>
                    <p class="catalog-hero-description">
                        {{ totalProducts }} produit{{ totalProducts > 1 ? 's' : '' }} reconditionné{{ totalProducts > 1 ? 's' : '' }}, testé{{ totalProducts > 1 ? 's' : '' }} et garanti{{ totalProducts > 1 ? 's' : '' }}
                    </p>
                </div>

                {# Tri rapide #}
                <form method="get" class="catalog-sort-form">
                    {% for k, v in app.request.query.all %}
                        {% if k != 'sort' %}
                            <input type="hidden" name="{{ k }}" value="{{ v }}">
                        {% endif %}
                    {% endfor %}
                    <label class="sort-label">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="21" y1="10" x2="3" y2="10"></line>
                            <line x1="21" y1="6" x2="3" y2="6"></line>
                            <line x1="21" y1="14" x2="3" y2="14"></line>
                            <line x1="21" y1="18" x2="3" y2="18"></line>
                        </svg>
                        Trier par
                    </label>
                    <select class="sort-select" name="sort" onchange="this.form.submit()">
                        {% set s = criteria.sort|default('date_desc') %}
                        <option value="date_desc" {{ s == 'date_desc' ? 'selected' : '' }}>Plus récents</option>
                        <option value="price_asc" {{ s == 'price_asc' ? 'selected' : '' }}>Prix croissant</option>
                        <option value="price_desc" {{ s == 'price_desc' ? 'selected' : '' }}>Prix décroissant</option>
                        <option value="name_asc" {{ s == 'name_asc' ? 'selected' : '' }}>Nom A-Z</option>
                    </select>
                </form>
            </div>
        </div>
    </section>

    {# === CATALOGUE PRINCIPAL === #}
    <section class="catalog-main-modern">
        <div class="container">
            <div class="catalog-grid">

                {# === SIDEBAR FILTRES AMÉLIORÉE === #}
                <aside class="catalog-sidebar-modern">
                    <form method="get" class="filters-panel">
                        <div class="filters-header">
                            <h2 class="filters-title">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="4" y1="21" x2="4" y2="14"></line>
                                    <line x1="4" y1="10" x2="4" y2="3"></line>
                                    <line x1="12" y1="21" x2="12" y2="12"></line>
                                    <line x1="12" y1="8" x2="12" y2="3"></line>
                                    <line x1="20" y1="21" x2="20" y2="16"></line>
                                    <line x1="20" y1="12" x2="20" y2="3"></line>
                                    <line x1="1" y1="14" x2="7" y2="14"></line>
                                    <line x1="9" y1="8" x2="15" y2="8"></line>
                                    <line x1="17" y1="16" x2="23" y2="16"></line>
                                </svg>
                                Filtres
                            </h2>
                            <a href="{{ path('catalog_index') }}" class="btn-reset">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="1 4 1 10 7 10"></polyline>
                                    <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
                                </svg>
                                Réinitialiser
                            </a>
                        </div>

                        {# Recherche #}
                        <div class="filter-group">
                            <label class="filter-label">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                </svg>
                                Recherche
                            </label>
                            <input type="search"
                                   class="filter-input"
                                   name="q"
                                   value="{{ criteria.q }}"
                                   placeholder="Réfrigérateur, lave-linge...">
                        </div>

                        {# Catégorie #}
                        <div class="filter-group">
                            <label class="filter-label">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                                </svg>
                                Catégorie
                            </label>
                            <select name="category" class="filter-select">
                                <option value="">Toutes les catégories</option>
                                {% for cat in categories %}
                                    <option value="{{ cat.id }}" {{ criteria.category == cat.id ? 'selected' : '' }}>
                                        {{ cat.name }} ({{ cat.products|length }})
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        {# Marque #}
                        <div class="filter-group">
                            <label class="filter-label">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                    <polyline points="21 15 16 10 5 21"></polyline>
                                </svg>
                                Marque
                            </label>
                            <select name="brand" class="filter-select">
                                <option value="">Toutes les marques</option>
                                {% for b in brands %}
                                    <option value="{{ b.id }}" {{ criteria.brand == b.id ? 'selected' : '' }}>
                                        {{ b.name }} ({{ b.products|length }})
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        {# Étiquette énergie avec couleurs #}
                        <div class="filter-group">
                            <label class="filter-label">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path>
                                </svg>
                                Efficacité énergétique
                            </label>
                            <div class="energy-grid">
                                <input type="radio" name="label" value="" id="energy-all"
                                    {{ not criteria.label ? 'checked' : '' }}>
                                <label for="energy-all" class="energy-option energy-all">Toutes</label>

                                {% for lbl in energyLabels %}
                                    <input type="radio"
                                           name="label"
                                           value="{{ lbl.value }}"
                                           id="energy-{{ lbl.value }}"
                                        {{ criteria.label == lbl.value ? 'checked' : '' }}>
                                    <label for="energy-{{ lbl.value }}"
                                           class="energy-option energy-{{ lbl.value|lower }}">
                                        {{ lbl.value == 'NA' ? 'Non classé' : lbl.value }}
                                    </label>
                                {% endfor %}
                            </div>
                        </div>

                        {# Prix #}
                        <div class="filter-group">
                            <label class="filter-label">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="1" x2="12" y2="23"></line>
                                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                                </svg>
                                Fourchette de prix
                            </label>
                            <div class="price-inputs">
                                <div class="price-input-group">
                                    <span class="price-currency">€</span>
                                    <input type="number"
                                           name="min"
                                           class="filter-input-price"
                                           value="{{ criteria.min }}"
                                           min="0"
                                           step="50"
                                           placeholder="Min">
                                </div>
                                <span class="price-separator">—</span>
                                <div class="price-input-group">
                                    <span class="price-currency">€</span>
                                    <input type="number"
                                           name="max"
                                           class="filter-input-price"
                                           value="{{ criteria.max }}"
                                           min="0"
                                           step="50"
                                           placeholder="Max">
                                </div>
                            </div>
                        </div>

                        {# Bouton appliquer #}
                        <button type="submit" class="btn-apply-filters">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                            Appliquer les filtres
                        </button>

                        {# Filtres actifs #}
                        {% set active = [] %}
                        {% if criteria.q %}{% set active = active|merge([{k:'q', v:criteria.q, label:'Recherche'}]) %}{% endif %}
                        {% if criteria.category %}
                            {% set catName = categories|filter(c => c.id == criteria.category)|first %}
                            {% if catName %}
                                {% set active = active|merge([{k:'category', v:catName.name, label:'Catégorie'}]) %}
                            {% endif %}
                        {% endif %}
                        {% if criteria.brand %}
                            {% set brandName = brands|filter(b => b.id == criteria.brand)|first %}
                            {% if brandName %}
                                {% set active = active|merge([{k:'brand', v:brandName.name, label:'Marque'}]) %}
                            {% endif %}
                        {% endif %}
                        {% if criteria.label %}{% set active = active|merge([{k:'label', v:criteria.label, label:'Étiquette'}]) %}{% endif %}
                        {% if criteria.min %}{% set active = active|merge([{k:'min', v:criteria.min ~ '€', label:'Prix min'}]) %}{% endif %}
                        {% if criteria.max %}{% set active = active|merge([{k:'max', v:criteria.max ~ '€', label:'Prix max'}]) %}{% endif %}

                        {% if active|length %}
                            <div class="active-filters">
                                <div class="active-filters-title">Filtres actifs</div>
                                <div class="active-filters-list">
                                    {% for f in active %}
                                        {% set qs = app.request.query.all|filter((v, k) => k != f.k) %}
                                        <a href="{{ path('catalog_index') ~ (qs ? '?' ~ qs|url_encode : '') }}"
                                           class="filter-pill">
                                            <span>{{ f.label }}: {{ f.v }}</span>
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                            </svg>
                                        </a>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}
                    </form>
                </aside>

                {# === GRILLE PRODUITS === #}
                <div class="catalog-products">
                    <div class="products-grid-modern">
                        {% for p in products %}
                            <article class="product-card-modern">
                                <a href="{{ path('catalog_show', {slug: p.slug}) }}" class="product-link">
                                    <div class="product-image-modern">
                                        {% if p.images|length > 0 %}
                                            <img src="{{ asset('uploads/products/' ~ p.images.first.filename) }}"
                                                 alt="{{ p.title }}"
                                                 loading="lazy">
                                        {% else %}
                                            <div class="product-placeholder">
                                                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                                    <polyline points="21 15 16 10 5 21"></polyline>
                                                </svg>
                                            </div>
                                        {% endif %}

                                        {# Badges #}
                                        <div class="product-badges-modern">
                                            {% if p.energyLabel %}
                                                <span class="badge-energy badge-energy-{{ p.energyLabel.value|lower }}">
                                                {{ p.energyLabel.value == 'NA' ? 'N/A' : p.energyLabel.value }}
                                            </span>
                                            {% endif %}
                                            {% if p.stock > 0 %}
                                                <span class="badge-stock">En stock</span>
                                            {% else %}
                                                <span class="badge-out">Rupture</span>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <div class="product-content-modern">
                                        <div class="product-meta-modern">
                                            {{ p.category.name }}
                                            {% if p.brand %} • {{ p.brand.name }}{% endif %}
                                        </div>

                                        <h3 class="product-title-modern">{{ p.title }}</h3>

                                        {% if p.shortDescription %}
                                            <p class="product-description-modern">{{ p.shortDescription }}</p>
                                        {% endif %}

                                        <div class="product-footer-modern">
                                            <div class="product-price-modern">
                                                {{ (p.price / 100)|format_currency('EUR') }}
                                            </div>

                                            {% if p.warrantyMonths %}
                                                <div class="product-warranty-modern">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                                                    </svg>
                                                    {{ p.warrantyMonths }} mois
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </a>
                            </article>
                        {% else %}
                            <div class="empty-state-modern">
                                <div class="empty-icon">
                                    <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                        <circle cx="11" cy="11" r="8"></circle>
                                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                    </svg>
                                </div>
                                <h3 class="empty-title">Aucun produit trouvé</h3>
                                <p class="empty-description">Essayez de modifier vos critères de recherche</p>
                                <a href="{{ path('catalog_index') }}" class="btn-empty">
                                    Réinitialiser les filtres
                                </a>
                            </div>
                        {% endfor %}
                    </div>

                    {# Pagination #}
                    {% if totalPages > 1 %}
                        <nav class="pagination-modern">
                            <ul class="pagination-list-modern">
                                {% for i in 1..totalPages %}
                                    {% set qs = app.request.query.all|merge({'page': i}) %}
                                    <li class="pagination-item-modern {{ i == currentPage ? 'active' : '' }}">
                                        <a href="{{ path('catalog_index') ~ '?' ~ qs|url_encode }}"
                                           class="pagination-link-modern">
                                            {{ i }}
                                        </a>
                                    </li>
                                {% endfor %}
                            </ul>
                        </nav>
                    {% endif %}
                </div>
            </div>
        </div>
    </section>

{% endblock %}
