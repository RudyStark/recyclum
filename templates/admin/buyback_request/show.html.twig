{% extends 'admin/base_layout.html.twig' %}
{% block body_class 'product-form-pro' %}

{% block content_title %}{% endblock %}
{% block page_actions %}{% endblock %}
{% block content_header_wrapper %}{% endblock %}

{% block main %}
    <div class="form-container">
        {# BREADCRUMB #}
        <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="{{ ea_url().setController('App\\Controller\\Admin\\BuybackRequestCrudController').setAction('requestIndex').generateUrl() }}">
                        <i class="fa fa-shopping-cart"></i> Demandes de rachat
                    </a>
                </li>
                <li class="breadcrumb-item active">Demande #{{ request.id }}</li>
            </ol>
        </nav>

        {# HERO HEADER #}
        <div class="form-hero-section">
            <div class="hero-icon">
                <i class="fa fa-eye"></i>
            </div>
            <div class="hero-content">
                <h1 class="hero-title">{{ request.fullName }}</h1>
                <p class="hero-subtitle">{{ request.categoryLabel }} ‚Ä¢ {{ request.brand|capitalize }} {{ request.model }} ‚Ä¢ Demande #{{ request.id }}</p>
            </div>
        </div>

        <div class="row g-4">
            {# COLONNE PRINCIPALE #}
            <div class="col-lg-8">
                {# STATUT ET DATE #}
                <div class="form-panel mb-4">
                    <div class="panel-header">
                        <h2 class="panel-title">
                            <i class="fa fa-info-circle"></i> Informations g√©n√©rales
                        </h2>
                    </div>
                    <div class="panel-body">
                        <div class="row g-3">
                            <div class="col-6">
                                <label class="form-label">Statut</label>
                                <div>
                                    <span class="badge" style="background-color: {{ request.statusBadgeColor }}; color: white; padding: 8px 14px; border-radius: 12px; font-size: 13px; display: inline-flex; align-items: center; gap: 8px;">
                                        <i class="fa {{ request.statusIcon }}"></i>
                                        {{ request.statusLabel }}
                                    </span>
                                </div>
                            </div>
                            <div class="col-6">
                                <label class="form-label">Date de demande</label>
                                <input type="text" class="form-control" value="{{ request.createdAt|date('d/m/Y √† H:i') }}" readonly>
                            </div>
                        </div>
                    </div>
                </div>

                {# INFORMATIONS APPAREIL #}
                <div class="form-panel mb-4">
                    <div class="panel-header">
                        <h2 class="panel-title">
                            <i class="fa fa-tv"></i> Appareil
                        </h2>
                    </div>
                    <div class="panel-body">
                        <div class="row g-3">
                            <div class="col-6">
                                <label class="form-label">Cat√©gorie</label>
                                <input type="text" class="form-control" value="{{ request.categoryLabel }}" readonly>
                            </div>
                            <div class="col-6">
                                <label class="form-label">Marque</label>
                                <input type="text" class="form-control" value="{{ request.brand|capitalize }}" readonly>
                            </div>
                            <div class="col-6">
                                <label class="form-label">Mod√®le / R√©f√©rence</label>
                                <input type="text" class="form-control" value="{{ request.model ?? 'N/A' }}" readonly>
                            </div>
                            <div class="col-6">
                                <label class="form-label">Num√©ro de s√©rie</label>
                                <input type="text" class="form-control" value="{{ request.serialNumber ?? 'N/A' }}" readonly>
                            </div>
                            <div class="col-6">
                                <label class="form-label">Ann√©e d'achat</label>
                                <input type="text" class="form-control" value="{{ request.purchaseYear }}" readonly>
                            </div>
                            <div class="col-6">
                                <label class="form-label">Facture d'achat</label>
                                <input type="text" class="form-control" value="{{ request.isHasInvoice ? '‚úì Oui (+10%)' : '‚úó Non' }}" readonly style="{% if request.isHasInvoice %}color: #16C669; font-weight: 600;{% endif %}">
                            </div>
                        </div>
                    </div>
                </div>

                {# √âTAT #}
                <div class="form-panel mb-4">
                    <div class="panel-header">
                        <h2 class="panel-title">
                            <i class="fa fa-wrench"></i> √âtat de l'appareil
                        </h2>
                    </div>
                    <div class="panel-body">
                        <div class="row g-3">
                            <div class="col-6">
                                <label class="form-label">√âtat fonctionnel</label>
                                <input type="text" class="form-control" value="{{ request.functionalConditionLabel }}" readonly>
                            </div>
                            <div class="col-6">
                                <label class="form-label">√âtat esth√©tique</label>
                                <input type="text" class="form-control" value="{{ request.aestheticConditionLabel }}" readonly>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Accessoires complets</label>
                                <input type="text" class="form-control" value="{{ request.isHasAllAccessories ? '‚úì Oui' : '‚úó Non (‚àí10%)' }}" readonly style="{% if not request.isHasAllAccessories %}color: #e74c3c; font-weight: 600;{% else %}color: #16C669; font-weight: 600;{% endif %}">
                            </div>
                            {% if request.defectsDescription %}
                                <div class="col-12">
                                    <label class="form-label">Description des d√©fauts</label>
                                    <textarea class="form-control" rows="3" readonly>{{ request.defectsDescription }}</textarea>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                {# PHOTOS #}
                <div class="form-panel mb-4">
                    <div class="panel-header">
                        <h2 class="panel-title">
                            <i class="fa fa-camera"></i> Photos
                        </h2>
                    </div>
                    <div class="panel-body">
                        <div class="row g-3">
                            {% if request.photo1 %}
                                <div class="col-4">
                                    <div style="position: relative;">
                                        <img src="{{ request.photo1 }}" alt="Photo 1" class="img-fluid rounded" style="width: 100%; height: 200px; object-fit: cover; cursor: pointer;" onclick="window.open(this.src, '_blank')">
                                        <div style="position: absolute; bottom: 8px; left: 8px; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 6px; font-size: 11px;">
                                            Photo 1
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                            {% if request.photo2 %}
                                <div class="col-4">
                                    <div style="position: relative;">
                                        <img src="{{ request.photo2 }}" alt="Photo 2" class="img-fluid rounded" style="width: 100%; height: 200px; object-fit: cover; cursor: pointer;" onclick="window.open(this.src, '_blank')">
                                        <div style="position: absolute; bottom: 8px; left: 8px; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 6px; font-size: 11px;">
                                            Photo 2
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                            {% if request.photo3 %}
                                <div class="col-4">
                                    <div style="position: relative;">
                                        <img src="{{ request.photo3 }}" alt="Photo 3" class="img-fluid rounded" style="width: 100%; height: 200px; object-fit: cover; cursor: pointer;" onclick="window.open(this.src, '_blank')">
                                        <div style="position: absolute; bottom: 8px; left: 8px; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 6px; font-size: 11px;">
                                            Photo 3
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                        {% if not request.photo1 and not request.photo2 and not request.photo3 %}
                            <div class="text-center text-muted py-3">
                                <i class="fa fa-image"></i> Aucune photo
                            </div>
                        {% endif %}
                    </div>
                </div>

                {# CLIENT #}
                <div class="form-panel mb-4">
                    <div class="panel-header">
                        <h2 class="panel-title">
                            <i class="fa fa-user"></i> Coordonn√©es client
                        </h2>
                    </div>
                    <div class="panel-body">
                        <div class="row g-3">
                            <div class="col-6">
                                <label class="form-label">Pr√©nom</label>
                                <input type="text" class="form-control" value="{{ request.firstName }}" readonly>
                            </div>
                            <div class="col-6">
                                <label class="form-label">Nom</label>
                                <input type="text" class="form-control" value="{{ request.lastName }}" readonly>
                            </div>
                            <div class="col-6">
                                <label class="form-label">Email</label>
                                <div class="input-group">
                                    <input type="email" class="form-control" value="{{ request.email }}" readonly>
                                    <a href="mailto:{{ request.email }}" class="btn btn-outline-secondary" title="Envoyer un email">
                                        <i class="fa fa-envelope"></i>
                                    </a>
                                </div>
                            </div>
                            <div class="col-6">
                                <label class="form-label">T√©l√©phone</label>
                                <div class="input-group">
                                    <input type="tel" class="form-control" value="{{ request.phone }}" readonly>
                                    <a href="tel:{{ request.phone }}" class="btn btn-outline-secondary" title="Appeler">
                                        <i class="fa fa-phone"></i>
                                    </a>
                                </div>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Adresse compl√®te</label>
                                <textarea class="form-control" rows="2" readonly>{{ request.fullAddress }}</textarea>
                            </div>
                        </div>
                    </div>
                </div>

                {# PAIEMENT #}
                <div class="form-panel">
                    <div class="panel-header">
                        <h2 class="panel-title">
                            <i class="fa fa-credit-card"></i> Informations de paiement
                        </h2>
                    </div>
                    <div class="panel-body">
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">Mode de paiement</label>
                                <input type="text" class="form-control" value="{{ request.paymentMethodLabel }}" readonly>
                            </div>
                            {% if request.iban %}
                                <div class="col-12">
                                    <label class="form-label">IBAN</label>
                                    <input type="text" class="form-control" value="{{ request.iban }}" readonly style="font-family: 'Courier New', monospace;">
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {# ‚úÖ HISTORIQUE TIMELINE - POSITION FINALE #}
                <div class="form-panel">
                    <div class="panel-header">
                        <h2 class="panel-title">
                            <i class="fa fa-history"></i> Historique de la demande
                        </h2>
                    </div>
                    <div class="panel-body">
                        <div class="timeline">
                            {# √âTAPE 1 : DEMANDE CR√â√âE #}
                            <div class="timeline-item {% if request.status != 'pending' %}completed{% endif %}">
                                <div class="timeline-marker">
                                    <i class="fa fa-check"></i>
                                </div>
                                <div class="timeline-content">
                                    <div class="timeline-title">Demande cr√©√©e</div>
                                    <div class="timeline-date">{{ request.createdAt|date('d/m/Y √† H:i') }}</div>
                                    <div class="timeline-details">
                                        <span class="timeline-badge">{{ request.categoryLabel }}</span>
                                        <span class="timeline-badge">{{ request.brand|capitalize }} {{ request.model }}</span>
                                    </div>
                                </div>
                            </div>

                            {# √âTAPE 2 : VALID√âE OU REFUS√âE #}
                            {% if request.status == 'validated' or request.status == 'appointment_scheduled' or request.status == 'awaiting_collection' or request.status == 'collected' or request.status == 'paid' %}
                                <div class="timeline-item completed">
                                    <div class="timeline-marker">
                                        <i class="fa fa-check-circle"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <div class="timeline-title">Demande valid√©e</div>
                                        <div class="timeline-date">{{ request.updatedAt|date('d/m/Y √† H:i') }}</div>
                                        <div class="timeline-details">
                                            {% if request.finalPrice %}
                                                <span class="timeline-badge timeline-badge-success">
                                                    <i class="fa fa-euro-sign"></i> {{ request.finalPrice|number_format(0, ',', ' ') }} ‚Ç¨
                                                </span>
                                            {% endif %}
                                            {% if request.needsHomePickup() %}
                                                <span class="timeline-badge timeline-badge-info">
                                                    <i class="fa fa-truck"></i> Enl√®vement requis
                                                </span>
                                            {% else %}
                                                <span class="timeline-badge timeline-badge-info">
                                                    <i class="fa fa-store"></i> D√©p√¥t magasin
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% elseif request.status == 'refused' %}
                                <div class="timeline-item completed timeline-item-refused">
                                    <div class="timeline-marker">
                                        <i class="fa fa-times-circle"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <div class="timeline-title">Demande refus√©e</div>
                                        <div class="timeline-date">{{ request.updatedAt|date('d/m/Y √† H:i') }}</div>
                                        {% if request.refusalReason %}
                                            <div class="timeline-details" style="margin-top: 0.5rem;">
                                                <div style="background: rgba(239, 68, 68, 0.1); border-left: 3px solid #ef4444; padding: 0.75rem; border-radius: 4px; font-size: 0.875rem; color: #7f1d1d;">
                                                    <strong>Motif :</strong> {{ request.refusalReason }}
                                                </div>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% else %}
                                <div class="timeline-item pending">
                                    <div class="timeline-marker">
                                        <i class="fa fa-clock"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <div class="timeline-title">En attente de validation</div>
                                        <div class="timeline-date">R√©ponse sous 24h</div>
                                    </div>
                                </div>
                            {% endif %}

                            {# √âTAPE 3 : RDV PLANIFI√â (si gros √©lectro) #}
                            {% if request.status == 'appointment_scheduled' or request.status == 'collected' or request.status == 'paid' %}
                                <div class="timeline-item completed">
                                    <div class="timeline-marker">
                                        <i class="fa fa-calendar-check"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <div class="timeline-title">Rendez-vous planifi√©</div>
                                        {% if appointment %}
                                            <div class="timeline-date">{{ appointment.fullDateTime }}</div>
                                            <div class="timeline-details">
                                                <span class="timeline-badge timeline-badge-primary">
                                                    <i class="fa fa-map-marker-alt"></i> {{ request.city }}
                                                </span>
                                            </div>
                                        {% else %}
                                            <div class="timeline-date">Date √† confirmer</div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% elseif request.status == 'awaiting_collection' %}
                                <div class="timeline-item completed">
                                    <div class="timeline-marker">
                                        <i class="fa fa-box"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <div class="timeline-title">En attente de d√©p√¥t</div>
                                        <div class="timeline-date">Magasin ouvert Lun-Sam</div>
                                        <div class="timeline-details">
                                            <span class="timeline-badge timeline-badge-info">
                                                <i class="fa fa-store"></i> √Ä apporter en magasin
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            {% elseif request.status == 'validated' and request.needsHomePickup() %}
                                <div class="timeline-item pending">
                                    <div class="timeline-marker">
                                        <i class="fa fa-calendar"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <div class="timeline-title">Planification du RDV</div>
                                        <div class="timeline-date">En attente du client</div>
                                    </div>
                                </div>
                            {% endif %}

                            {# √âTAPE 4 : COLLECT√â #}
                            {% if request.status == 'collected' or request.status == 'paid' %}
                                <div class="timeline-item completed">
                                    <div class="timeline-marker">
                                        <i class="fa fa-truck"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <div class="timeline-title">Appareil r√©cup√©r√©</div>
                                        <div class="timeline-date">{{ request.updatedAt|date('d/m/Y √† H:i') }}</div>
                                        <div class="timeline-details">
                                            <span class="timeline-badge timeline-badge-success">
                                                <i class="fa fa-check"></i> En stock
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            {% elseif request.status == 'appointment_scheduled' or request.status == 'awaiting_collection' %}
                                <div class="timeline-item pending">
                                    <div class="timeline-marker">
                                        <i class="fa fa-truck"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <div class="timeline-title">R√©cup√©ration</div>
                                        <div class="timeline-date">√Ä venir</div>
                                    </div>
                                </div>
                            {% endif %}

                            {# √âTAPE 5 : PAY√â #}
                            {% if request.status == 'paid' %}
                                <div class="timeline-item completed timeline-item-success">
                                    <div class="timeline-marker">
                                        <i class="fa fa-euro-sign"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <div class="timeline-title">Client pay√©</div>
                                        <div class="timeline-date">{{ request.updatedAt|date('d/m/Y √† H:i') }}</div>
                                        <div class="timeline-details">
                                            <span class="timeline-badge timeline-badge-success">
                                                <i class="fa fa-check-circle"></i>
                                                {{ request.finalPrice ? request.finalPrice : request.estimatedPrice }} ‚Ç¨
                                                {% if request.paymentMethod == 'virement' %}(Virement){% else %}(Esp√®ces){% endif %}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            {% elseif request.status == 'collected' %}
                                <div class="timeline-item pending">
                                    <div class="timeline-marker">
                                        <i class="fa fa-euro-sign"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <div class="timeline-title">Paiement du client</div>
                                        <div class="timeline-date">√Ä effectuer</div>
                                    </div>
                                </div>
                            {% endif %}

                            {# ANNUL√âE #}
                            {% if request.status == 'cancelled' %}
                                <div class="timeline-item completed timeline-item-cancelled">
                                    <div class="timeline-marker">
                                        <i class="fa fa-ban"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <div class="timeline-title">Demande annul√©e</div>
                                        <div class="timeline-date">{{ request.updatedAt|date('d/m/Y √† H:i') }}</div>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            {# SIDEBAR #}
            <div class="col-lg-4">
                {# ESTIMATION #}
                <div class="form-panel mb-4" style="background: linear-gradient(135deg, #16C669 0%, #12A85A 100%); color: white;">
                    <div class="panel-header" style="border-bottom-color: rgba(255,255,255,0.2);">
                        <h2 class="panel-title" style="color: white;">
                            <i class="fa fa-calculator"></i> Estimation
                        </h2>
                    </div>
                    <div class="panel-body text-center">
                        <div class="mb-2" style="font-size: 0.9rem; opacity: 0.9;">Prix estim√©</div>
                        <div style="font-size: 2.5rem; font-weight: 900; margin: 1rem 0;">
                            {{ request.estimatedPrice|number_format(0, ',', ' ') }} ‚Ç¨
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 0.75rem; border-radius: 8px; font-size: 0.85rem; margin-top: 1rem;">
                            <i class="fa fa-info-circle"></i> Prix d√©finitif apr√®s validation sur place
                        </div>

                        {% if request.finalPrice %}
                            <hr style="border-color: rgba(255,255,255,0.2); margin: 1.5rem 0;">
                            <div class="mb-2" style="font-size: 0.9rem; opacity: 0.9;">Prix final valid√©</div>
                            <div style="font-size: 2rem; font-weight: 900;">
                                {{ request.finalPrice|number_format(0, ',', ' ') }} ‚Ç¨
                            </div>
                        {% endif %}
                    </div>
                </div>

                {# ACTIONS WORKFLOW #}
                <div class="form-panel mb-4">
                    <div class="panel-header">
                        <h2 class="panel-title">
                            <i class="fa fa-tasks"></i> Gestion du workflow
                        </h2>
                    </div>
                    <div class="panel-body" data-controller="admin--buyback-actions" data-admin--buyback-actions-request-id-value="{{ request.id }}" data-admin--buyback-actions-current-status-value="{{ request.status }}">

                        {# DROPDOWN CHANGEMENT DE STATUT #}
                        <div class="mb-3">
                            <label class="form-label fw-bold">Changer le statut</label>
                            <select class="form-select" data-action="change->admin--buyback-actions#changeStatus" data-admin--buyback-actions-target="statusSelect">
                                <option value="">-- S√©lectionner une action --</option>

                                {% if request.canBeValidated() %}
                                    <option value="validate">‚úì Valider la demande</option>
                                    <option value="refuse">‚úó Refuser la demande</option>
                                {% endif %}

                                {% if request.status == 'validated' and not request.needsHomePickup() %}
                                    <option value="awaiting_collection">üì¶ En attente d√©p√¥t magasin</option>
                                {% endif %}

                                {% if request.canMarkAsCollected() %}
                                    <option value="collected">üöö Marquer comme collect√©</option>
                                {% endif %}

                                {% if request.canMarkAsPaid() %}
                                    <option value="paid">üí∞ Marquer comme pay√©</option>
                                {% endif %}

                                {% if request.status not in ['cancelled', 'refused', 'paid'] %}
                                    <option value="cancel">üö´ Annuler la demande</option>
                                {% endif %}
                            </select>
                        </div>

                        {# ALERTE SI GROS √âLECTRO VALID√â #}
                        {% if request.status == 'validated' and request.needsHomePickup() %}
                            <div class="alert alert-info" style="background: rgba(59, 130, 246, 0.1); border: 2px solid #3B82F6; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                                <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                                    <i class="fa fa-calendar-check" style="color: #3B82F6; font-size: 1.25rem; margin-top: 2px;"></i>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 700; color: #1E40AF; margin-bottom: 0.5rem;">Enl√®vement requis</div>
                                        <div style="font-size: 0.875rem; color: #1E3A8A; margin-bottom: 0.75rem;">
                                            Le client doit choisir un cr√©neau d'enl√®vement
                                        </div>
                                        {% if request.appointmentToken %}
                                            <a href="{{ url('buyback_appointment_calendar', {token: request.appointmentToken}) }}"
                                               class="btn btn-sm btn-primary"
                                               target="_blank"
                                               style="background: #3B82F6; border: none; font-size: 0.8rem; padding: 0.5rem 0.75rem;">
                                                <i class="fa fa-external-link-alt"></i> Lien calendrier client
                                            </a>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endif %}

                        {# INFORMATIONS RDV SI PLANIFI√â #}
                        {% if request.status == 'appointment_scheduled' and appointment %}
                            <div class="alert mb-3" style="background: linear-gradient(135deg, rgba(22, 198, 105, 0.1) 0%, rgba(22, 198, 105, 0.05) 100%); border: 2px solid #16C669; border-radius: 12px; padding: 0; overflow: hidden; margin-bottom: 1rem;">
                                {# HEADER #}
                                <div style="background: linear-gradient(135deg, #16C669 0%, #12A85A 100%); color: white; padding: 1rem 1.25rem; display: flex; align-items: center; gap: 0.75rem;">
                                    <div style="width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                        <i class="fa fa-calendar-check" style="font-size: 1.125rem;"></i>
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 800; font-size: 1rem; margin-bottom: 2px;">Rendez-vous confirm√©</div>
                                        <div style="font-size: 0.8rem; opacity: 0.9;">Enl√®vement √† domicile</div>
                                    </div>
                                </div>

                                {# BODY #}
                                <div style="padding: 1.25rem;">
                                    {# DATE ET HEURE #}
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                        <div>
                                            <div style="font-size: 0.75rem; color: #6c7783; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.375rem;">üìÖ Date</div>
                                            <div style="font-weight: 700; color: #1a2332; font-size: 0.9rem;">{{ appointment.formattedDate }}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 0.75rem; color: #6c7783; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.375rem;">üïê Heure</div>
                                            <div style="font-weight: 700; color: #1a2332; font-size: 0.9rem;">{{ appointment.appointmentTime }}</div>
                                        </div>
                                    </div>

                                    {# ADRESSE #}
                                    <div style="margin-bottom: 1rem;">
                                        <div style="font-size: 0.75rem; color: #6c7783; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.375rem;">üìç Adresse</div>
                                        <div style="font-weight: 600; color: #1a2332; font-size: 0.875rem; line-height: 1.4;">
                                            {{ request.address }}<br>
                                            {{ request.postalCode }} {{ request.city }}
                                        </div>
                                    </div>

                                    {# MONTANT #}
                                    <div style="background: rgba(22, 198, 105, 0.08); border: 2px dashed #16C669; border-radius: 8px; padding: 0.875rem; text-align: center;">
                                        <div style="font-size: 0.75rem; color: #0F5132; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem;">üí∞ Montant √† payer au client</div>
                                        <div style="font-weight: 900; color: #16C669; font-size: 1.5rem;">
                                            {{ request.finalPrice ? request.finalPrice : request.estimatedPrice }} ‚Ç¨
                                        </div>
                                        <div style="font-size: 0.75rem; color: #146C43; margin-top: 0.25rem;">
                                            {% if request.paymentMethod == 'virement' %}
                                                Virement bancaire apr√®s enl√®vement
                                            {% else %}
                                                Esp√®ces sur place
                                            {% endif %}
                                        </div>
                                    </div>

                                    {# NOTES RDV SI EXISTENT #}
                                    {% if appointment.notes %}
                                        <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(59, 130, 246, 0.05); border-left: 3px solid #3B82F6; border-radius: 4px;">
                                            <div style="font-size: 0.75rem; color: #1E40AF; font-weight: 600; margin-bottom: 0.375rem;">üìù Notes RDV</div>
                                            <div style="font-size: 0.8rem; color: #1E3A8A;">{{ appointment.notes }}</div>
                                        </div>
                                    {% endif %}
                                </div>

                                {# FOOTER #}
                                <div style="background: rgba(22, 198, 105, 0.05); padding: 0.875rem 1.25rem; border-top: 1px solid rgba(22, 198, 105, 0.2); display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fa fa-info-circle" style="color: #16C669; font-size: 0.875rem;"></i>
                                    <div style="font-size: 0.75rem; color: #0F5132; line-height: 1.4;">
                                        Pensez √† appeler le client la veille pour confirmer
                                    </div>
                                </div>
                            </div>
                        {% elseif request.status == 'appointment_scheduled' and not appointment %}
                            {# FALLBACK SI PAS DE RDV TROUV√â #}
                            <div class="alert alert-warning" style="background: rgba(245, 158, 11, 0.1); border: 2px solid #f59e0b; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                                <div style="font-weight: 700; color: #92400e; margin-bottom: 0.5rem;">
                                    <i class="fa fa-exclamation-triangle"></i> RDV non trouv√©
                                </div>
                                <div style="font-size: 0.875rem; color: #78350f;">
                                    Le statut indique un RDV planifi√© mais aucun rendez-vous n'a √©t√© trouv√© en base de donn√©es.
                                </div>
                            </div>
                        {% endif %}

                        <hr style="margin: 1.5rem 0;">

                        {# ACTIONS RAPIDES CONTACT #}
                        <div class="d-grid gap-2">
                            <a href="mailto:{{ request.email }}" class="btn btn-outline-primary btn-sm">
                                <i class="fa fa-envelope"></i> Envoyer un email
                            </a>
                            <a href="tel:{{ request.phone }}" class="btn btn-outline-success btn-sm">
                                <i class="fa fa-phone"></i> Appeler le client
                            </a>
                        </div>
                    </div>
                </div>

                {# NOTES √âDITABLES #}
                <div class="form-panel">
                    <div class="panel-header">
                        <h2 class="panel-title">
                            <i class="fa fa-sticky-note"></i> Notes internes
                        </h2>
                    </div>
                    <div class="panel-body" data-controller="admin--buyback-notes" data-admin--buyback-notes-request-id-value="{{ request.id }}">
                        <textarea
                            class="form-control"
                            rows="5"
                            placeholder="Ajouter des notes internes..."
                            data-admin--buyback-notes-target="textarea"
                            data-action="blur->admin--buyback-notes#save">{{ request.adminNotes }}</textarea>

                        <div class="mt-2" data-admin--buyback-notes-target="saveStatus" style="display: none;">
                            <small class="text-success">
                                <i class="fa fa-check"></i> Sauvegard√©
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {# FOOTER ACTIONS #}
        <div class="form-actions mt-4">
            <a href="{{ ea_url().setController('App\\Controller\\Admin\\BuybackRequestCrudController').setAction('requestIndex').generateUrl() }}" class="btn btn-outline-secondary">
                <i class="fa fa-arrow-left"></i> Retour √† la liste
            </a>
            <div>
                <form method="post" action="{{ path('admin_buyback_request_delete', {id: request.id}) }}" style="display: inline;" onsubmit="return confirm('√ätes-vous s√ªr de vouloir supprimer cette demande ?');">
                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ request.id) }}">
                    <button type="submit" class="btn btn-danger">
                        <i class="fa fa-trash"></i> Supprimer
                    </button>
                </form>
            </div>
        </div>
    </div>

    {# ========================================
       MODALES
       ======================================== #}

    {# MODALE VALIDATION #}
    <div class="modal fade" id="validateModal" tabindex="-1" data-controller="admin--buyback-validate-modal" data-admin--buyback-validate-modal-request-id-value="{{ request.id }}" data-admin--buyback-validate-modal-estimated-price-value="{{ request.estimatedPrice }}">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border-radius: 16px; border: none; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                <div class="modal-header" style="background: linear-gradient(135deg, #16C669 0%, #12A85A 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                    <h5 class="modal-title" style="font-weight: 800; font-size: 1.25rem;">
                        <i class="fa fa-check-circle"></i> Valider la demande
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="padding: 2rem;">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Prix estim√© de rachat</label>
                        <div style="background: linear-gradient(135deg, rgba(22, 198, 105, 0.1) 0%, rgba(22, 198, 105, 0.05) 100%); border: 2px solid #16C669; border-radius: 12px; padding: 1.5rem; text-align: center;">
                            <div style="font-size: 0.875rem; color: #0F5132; margin-bottom: 0.5rem;">üí∞ Nous payons au client</div>
                            <div style="font-size: 2.5rem; font-weight: 900; color: #16C669;">
                                {{ request.estimatedPrice|number_format(0, ',', ' ') }} ‚Ç¨
                            </div>
                            <div style="font-size: 0.75rem; color: #146C43; margin-top: 0.5rem;">Prix estim√© - sera confirm√© sur place</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Message personnalis√© (optionnel)</label>
                        <textarea
                            class="form-control"
                            rows="4"
                            placeholder="Ajoutez un message qui sera envoy√© au client par email..."
                            data-admin--buyback-validate-modal-target="messageInput"></textarea>
                        <small class="text-muted">Ce message sera inclus dans l'email de validation</small>
                    </div>

                    <div class="alert alert-info" style="background: rgba(59, 130, 246, 0.1); border: 2px solid #3B82F6; border-radius: 8px; margin-bottom: 0;">
                        <div style="display: flex; gap: 0.75rem;">
                            <i class="fa fa-info-circle" style="color: #3B82F6; font-size: 1.25rem; margin-top: 2px;"></i>
                            <div style="flex: 1;">
                                <div style="font-weight: 700; color: #1E40AF; font-size: 0.875rem; margin-bottom: 0.25rem;">Que se passe-t-il ensuite ?</div>
                                <ul style="font-size: 0.8rem; color: #1E3A8A; margin: 0; padding-left: 1.25rem;">
                                    {% if request.needsHomePickup() %}
                                        <li>Le client recevra un lien pour choisir un cr√©neau d'enl√®vement</li>
                                        <li>Le transporteur confirmera le prix final sur place</li>
                                        <li>Vous pourrez ajuster le prix lors de la collecte si n√©cessaire</li>
                                    {% else %}
                                        <li>Le client recevra les instructions pour d√©poser l'appareil en magasin</li>
                                        <li>Vous confirmerez le prix final lors du d√©p√¥t</li>
                                    {% endif %}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #e5e7eb; padding: 1.25rem;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fa fa-times"></i> Annuler
                    </button>
                    <button
                        type="button"
                        class="btn btn-success"
                        data-action="click->admin--buyback-validate-modal#submit"
                        data-admin--buyback-validate-modal-target="submitBtn"
                        style="background: linear-gradient(135deg, #16C669 0%, #12A85A 100%); border: none; font-weight: 700;">
                        <i class="fa fa-check"></i> Valider la demande
                    </button>
                </div>
            </div>
        </div>
    </div>

    {# MODALE REFUS #}
    <div class="modal fade" id="refuseModal" tabindex="-1" data-controller="admin--buyback-refuse-modal" data-admin--buyback-refuse-modal-request-id-value="{{ request.id }}">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border-radius: 16px; border: none; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                <div class="modal-header" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                    <h5 class="modal-title" style="font-weight: 800; font-size: 1.25rem;">
                        <i class="fa fa-times-circle"></i> Refuser la demande
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="padding: 2rem;">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Motif du refus <span class="text-danger">*</span></label>
                        <textarea
                            class="form-control"
                            rows="5"
                            placeholder="Expliquez pourquoi vous refusez cette demande..."
                            data-admin--buyback-refuse-modal-target="reasonInput"
                            required></textarea>
                        <small class="text-muted">Ce message sera envoy√© au client par email</small>
                    </div>

                    <div class="alert alert-warning" style="background: rgba(245, 158, 11, 0.1); border: 2px solid #f59e0b; border-radius: 8px; margin-bottom: 0;">
                        <div style="display: flex; gap: 0.75rem;">
                            <i class="fa fa-exclamation-triangle" style="color: #f59e0b; font-size: 1.25rem; margin-top: 2px;"></i>
                            <div style="flex: 1;">
                                <div style="font-weight: 700; color: #92400e; font-size: 0.875rem; margin-bottom: 0.25rem;">Alternatives propos√©es au client</div>
                                <ul style="font-size: 0.8rem; color: #78350f; margin: 0; padding-left: 1.25rem;">
                                    <li>Service de r√©paration Recyclum</li>
                                    <li>Catalogue de produits reconditionn√©s</li>
                                    <li>Diagnostic gratuit de l'appareil</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #e5e7eb; padding: 1.25rem;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fa fa-times"></i> Annuler
                    </button>
                    <button
                        type="button"
                        class="btn btn-danger"
                        data-action="click->admin--buyback-refuse-modal#submit"
                        data-admin--buyback-refuse-modal-target="submitBtn"
                        style="font-weight: 700;">
                        <i class="fa fa-times-circle"></i> Confirmer le refus
                    </button>
                </div>
            </div>
        </div>
    </div>

    {# MODALE PAIEMENT #}
    <div class="modal fade" id="paymentModal" tabindex="-1" data-controller="admin--buyback-payment-modal" data-admin--buyback-payment-modal-request-id-value="{{ request.id }}" data-admin--buyback-payment-modal-final-price-value="{{ request.finalPrice ?? request.estimatedPrice }}">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border-radius: 16px; border: none; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                <div class="modal-header" style="background: linear-gradient(135deg, #16C669 0%, #12A85A 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                    <h5 class="modal-title" style="font-weight: 800; font-size: 1.25rem;">
                        <i class="fa fa-euro-sign"></i> Confirmer le paiement
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="padding: 2rem;">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Montant pay√© <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input
                                type="number"
                                class="form-control"
                                value="{{ request.finalPrice ?? request.estimatedPrice }}"
                                min="0"
                                data-admin--buyback-payment-modal-target="amountInput"
                                style="font-size: 1.5rem; font-weight: 800; text-align: right;">
                            <span class="input-group-text" style="background: rgba(22, 198, 105, 0.1); border-left: none; font-weight: 800; color: #16C669; font-size: 1.25rem;">‚Ç¨</span>
                        </div>
                        <small class="text-muted">Prix valid√© : {{ request.finalPrice ?? request.estimatedPrice }} ‚Ç¨</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Mode de paiement <span class="text-danger">*</span></label>
                        <select class="form-select" data-admin--buyback-payment-modal-target="methodSelect" style="font-weight: 600;">
                            <option value="virement" {% if request.paymentMethod == 'virement' %}selected{% endif %}>üí≥ Virement bancaire</option>
                            <option value="especes" {% if request.paymentMethod == 'especes' %}selected{% endif %}>üíµ Esp√®ces</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Note (optionnel)</label>
                        <textarea
                            class="form-control"
                            rows="3"
                            placeholder="Ex: Virement effectu√© le..."
                            data-admin--buyback-payment-modal-target="noteInput"></textarea>
                    </div>

                    <div class="alert alert-success" style="background: rgba(22, 198, 105, 0.1); border: 2px solid #16C669; border-radius: 8px; margin-bottom: 0;">
                        <div style="display: flex; gap: 0.75rem;">
                            <i class="fa fa-check-circle" style="color: #16C669; font-size: 1.25rem; margin-top: 2px;"></i>
                            <div style="flex: 1; font-size: 0.875rem; color: #0F5132;">
                                <strong>Finalisation :</strong> Cette action cl√¥ture la demande. Le client sera notifi√© du paiement.
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #e5e7eb; padding: 1.25rem;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fa fa-times"></i> Annuler
                    </button>
                    <button
                        type="button"
                        class="btn btn-success"
                        data-action="click->admin--buyback-payment-modal#submit"
                        data-admin--buyback-payment-modal-target="submitBtn"
                        style="background: linear-gradient(135deg, #16C669 0%, #12A85A 100%); border: none; font-weight: 700;">
                        <i class="fa fa-check"></i> Confirmer le paiement
                    </button>
                </div>
            </div>
        </div>
    </div>

    {# MODALE COLLECTE #}
    <div class="modal fade" id="collectedModal" tabindex="-1" data-controller="admin--buyback-collected-modal" data-admin--buyback-collected-modal-request-id-value="{{ request.id }}" data-admin--buyback-collected-modal-estimated-price-value="{{ request.estimatedPrice }}">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border-radius: 16px; border: none; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                <div class="modal-header" style="background: linear-gradient(135deg, #16C669 0%, #12A85A 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                    <h5 class="modal-title" style="font-weight: 800; font-size: 1.25rem;">
                        <i class="fa fa-truck"></i> Confirmer la collecte
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="padding: 2rem;">
                    <div class="alert alert-warning" style="background: rgba(245, 158, 11, 0.1); border: 2px solid #f59e0b; border-radius: 8px; margin-bottom: 1.5rem;">
                        <div style="display: flex; gap: 0.75rem;">
                            <i class="fa fa-exclamation-triangle" style="color: #f59e0b; font-size: 1.25rem; margin-top: 2px;"></i>
                            <div style="flex: 1; font-size: 0.875rem; color: #78350f;">
                                <strong>Important :</strong> Confirmez le prix apr√®s v√©rification de l'√©tat r√©el de l'appareil. Vous pouvez ajuster le prix si l'√©tat ne correspond pas √† la description.
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Prix confirm√© apr√®s v√©rification <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input
                                type="number"
                                class="form-control"
                                value="{{ request.estimatedPrice }}"
                                min="0"
                                data-admin--buyback-collected-modal-target="priceInput"
                                style="font-size: 1.25rem; font-weight: 700;">
                            <span class="input-group-text" style="background: rgba(22, 198, 105, 0.1); border-left: none; font-weight: 800; color: #16C669; font-size: 1rem;">‚Ç¨</span>
                        </div>
                        <small class="text-muted">Prix estim√© initial : {{ request.estimatedPrice }} ‚Ç¨</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Note de v√©rification (optionnel)</label>
                        <textarea
                            class="form-control"
                            rows="3"
                            placeholder="Ex: √âtat conforme, accessoires complets..."
                            data-admin--buyback-collected-modal-target="noteInput"></textarea>
                        <small class="text-muted">Notez tout ajustement de prix ou probl√®me constat√©</small>
                    </div>

                    <div class="alert alert-success" style="background: rgba(22, 198, 105, 0.1); border: 2px solid #16C669; border-radius: 8px; margin-bottom: 0;">
                        <div style="display: flex; gap: 0.75rem;">
                            <i class="fa fa-check-circle" style="color: #16C669; font-size: 1.25rem; margin-top: 2px;"></i>
                            <div style="flex: 1; font-size: 0.875rem; color: #0F5132;">
                                <strong>Prochaine √©tape :</strong> Une fois collect√©, vous pourrez proc√©der au paiement du client avec le prix confirm√©.
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #e5e7eb; padding: 1.25rem;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fa fa-times"></i> Annuler
                    </button>
                    <button
                        type="button"
                        class="btn btn-success"
                        data-action="click->admin--buyback-collected-modal#submit"
                        data-admin--buyback-collected-modal-target="submitBtn"
                        style="background: linear-gradient(135deg, #16C669 0%, #12A85A 100%); border: none; font-weight: 700;">
                        <i class="fa fa-check"></i> Confirmer la collecte
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
